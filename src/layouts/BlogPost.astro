---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import AffiliateDisclosure from '../components/AffiliateDisclosure.astro';
import BuyButton from '../components/BuyButton.astro';
import StarRating from '../components/StarRating.astro';
import YouTubeEmbed from '../components/YouTubeEmbed.astro';

type Props = CollectionEntry<'blog'>['data'];

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  type = 'post',
  rating,
  affiliateLinks = [],
  parts = [],
  videoUrl,
  canonicalUrl,
  tags = [],
}: Props = Astro.props;

const canonical = canonicalUrl ?? new URL(Astro.url.pathname, Astro.site).href;
const imageUrl = heroImage ? new URL(heroImage.src, Astro.site).href : undefined;
const jsonLd: Record<string, any> = {
  '@context': 'https://schema.org',
  '@type': type === 'review' ? 'Review' : 'Article',
  headline: title,
  description,
  datePublished: pubDate.toISOString(),
  dateModified: (updatedDate ?? pubDate).toISOString(),
  url: canonical,
  image: imageUrl,
};
if (type === 'review') {
  jsonLd.itemReviewed = { '@type': 'Product', name: title };
  if (typeof rating === 'number') {
    jsonLd.reviewRating = {
      '@type': 'Rating',
      ratingValue: rating,
      bestRating: 5,
      worstRating: 1,
    };
  }
}
if (videoUrl) {
  jsonLd.video = {
    '@type': 'VideoObject',
    name: title,
    uploadDate: pubDate.toISOString(),
    embedUrl: videoUrl,
    thumbnailUrl: imageUrl ? [imageUrl] : undefined,
  };
}
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={heroImage} />
		<link rel="canonical" href={canonical} />
		<script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			}
			.hero-image {
				width: 100%;
				position: relative;
			}
			.hero-image::after {
				content: "";
				position: absolute;
				inset: 10px -10px -10px 10px;
				z-index: 0;
				background-image: radial-gradient(rgba(0,0,0,.08) 1px, transparent 1px);
				background-size: 8px 8px;
				opacity: .22;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: none;
				filter: grayscale(100%) contrast(0.95);
				position: relative;
				z-index: 1;
			}
			.prose {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1.25em 1.25em 1.5em;
				color: rgb(var(--gray-dark));
				background: var(--paper);
				border: 1px solid var(--rule);
				position: relative;
			}
			.prose::before {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.35'/></svg>");
				background-size: 200px 200px;
				opacity: .08;
				mix-blend-mode: multiply;
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
			}
			.meta {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
			}
			.last-updated-on {
				font-style: italic;
			}
			.buy-row { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin:1rem 0; }
			.parts { margin:1.5rem 0; }
			.parts a { text-decoration:none; }
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="prose">
					<div class="title">
						<div class="meta">
							<FormattedDate date={pubDate} />
							{updatedDate && (
								<div class="last-updated-on">Last updated on <FormattedDate date={updatedDate} /></div>
							)}
						</div>
						<h1>{title}</h1>
						{typeof rating === 'number' && <StarRating value={rating} />}
						<hr />
					</div>
					{affiliateLinks.length > 0 && <AffiliateDisclosure />}
					{affiliateLinks.length > 0 && (
						<div class="buy-row">
							{affiliateLinks.map((l) => <BuyButton href={l.url} label={l.label} />)}
						</div>
					)}

					{videoUrl && <YouTubeEmbed url={videoUrl} />}

					{parts.length > 0 && (
						<div class="parts">
							<h3>Parts List</h3>
							<ul>
								{parts.map((p) => (
									<li><a href={p.url} target="_blank" rel="sponsored noopener nofollow">{p.name}</a></li>
								))}
							</ul>
						</div>
					)}

					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
